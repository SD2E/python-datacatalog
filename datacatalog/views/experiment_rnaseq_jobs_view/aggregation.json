{
    "view_on": "jobs",
    "pipeline": [
	    {
	        "$match": {
	            "child_of": { "$not": {"$size": 0} },
	            "state": { "$in": ["FINISHED", "VALIDATED"] }
	        }
	    },
	    {
	    	"$lookup": {
		        "from": "pipelines",
		        "localField": "pipeline_uuid",
		        "foreignField": "uuid",
		        "as": "nc_rnaseq_jobs"
		    }
	    },
	    {
	        "$match": {
	        	"nc_rnaseq_jobs.name": { "$regex" : "Novel Chassis RNAseq Alignment Aggregation" }
	        }
	    },
	    {
	        "$lookup": {
	            "from": "experiments",
	            "localField": "child_of",
	            "foreignField": "uuid",
	            "as": "experiment_rnaseq_jobs"
	        }
	    },
	    { 
	    	"$unwind": "$experiment_rnaseq_jobs"
	    },    
	    {
	        "$lookup": {
	            "from": "experiment_designs",
	            "localField": "experiment_rnaseq_jobs.child_of",
	            "foreignField": "uuid",
	            "as": "experiment_design_rnaseq_jobs"
	        }
	    },
	    {
	        "$unwind": "$experiment_design_rnaseq_jobs"
	    },    
	    { 
	        "$addFields": { 
	            "derived_from": { 
	                "$ifNull": [ "$experiment_rnaseq_jobs.derived_from", ["unspecified"] ] 
	            }
	        }
	    },    
	    { 
	        "$lookup": {
	            "from": "files",
	            "localField": "derived_from",
	            "foreignField": "uuid",
	            "as": "experiment_design_files_rnaseq_jobs"
	        }
	    },
	    {   
	        "$project": {
	            "_id": false,
	            "experiment_id": "$experiment_rnaseq_jobs.experiment_id",
	            "experiment_design_id": "$experiment_design_rnaseq_jobs.experiment_design_id",
			    "storage_system": {
			        "$cond": { 
			            "if": { "$eq": [ { "$arrayElemAt": [ "$derived_from", 0 ] }, "unspecified" ] }, 
			            "then": "unspecified", 
			            "else": { "$arrayElemAt": ["$experiment_design_files_rnaseq_jobs.storage_system", 0] }
			        }
			    },
			    "samples_json": {
			        "$cond": { 
			            "if": { "$eq": [ { "$arrayElemAt": [ "$derived_from", 0 ] }, "unspecified" ] }, 
			            "then": "unspecified", 
			            "else": { "$arrayElemAt": ["$experiment_design_files_rnaseq_jobs.name", 0] }
			        }
			    },            
	            "job_uuid": "$uuid",
	            "last_updated": "$updated",
	            "settings": "$data",
	            "state": "$state",
	            "archive_path": "$archive_path"
	        } 
	    },
	    {
	        "$group": {
	            "_id": {
	                "experiment_id": "$experiment_id",
	                "experiment_design_id": "$experiment_design_id",
	                "storage_system": "$storage_system",
	                "samples_json": "$samples_json"
	            },
	            "jobs": {
	                "$push": {
	                    "job_uuid": "$job_uuid",
	                    "last_updated": "$last_updated",
	                    "settings": "$settings",
	                    "state": "$state",
	                    "archive_path": "$archive_path"
	                }
	            }
	        }
	    },
	    {
	        "$sort": {
	            "_id.experiment_id": 1
	        }
	    }
    ]
}